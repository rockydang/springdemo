<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!--Topic 映射关系配置文件 -->
<mapper namespace="com.mogujie.service.arkmaster.dao.topic.ArticleDao">
	<sql id="basicColumn">
		id,sort,title,img,description,marketId,topicId,type,isRecomItem,itemDataSource,itemInfos,publishTime,editorId,extra,status,isDeleted,created,updated,dataSourceCode,link,isWellChoiced,editorNick
	</sql>
	<sql id="basicValues">
		#{id}, #{sort}, #{title}, #{img}, #{description}, #{marketId}, #{topicId}, #{type}, #{isRecomItem},#{itemDataSource}, #{itemInfos},#{publishTime},#{editorId},#{extra},#{status},#{isDeleted},#{created},#{updated},#{dataSourceCode},#{link},#{isWellChoiced},#{editorNick}
	</sql>

	<sql id="Where_Clause">
		<!-- ignore isDeleted = 1 -->
		isDeleted &lt;&gt; 1
		<if test="id != null">
			and id = #{id}
		</if>
		<if test="title != null and title != ''">
			and title like CONCAT('%','${title}','%' )
		</if>
		<if test="marketId != null">
			and marketId = #{marketId}
		</if>
		<if test="topicId != null">
			and topicId = #{topicId}
		</if>
		<if test="isDeleted != null">
			and isDeleted = #{isDeleted}
		</if>
		<if test="editorNick != null and editorNick != ''">
			and editorNick = #{editorNick}
		</if>
		<if test="isWellChoiced != null">
			and isWellChoiced = #{isWellChoiced}
		</if>
		<if test="type != null">
			and type = #{type}
		</if>
		<if test="publishTime != null and publishTime != 0">
			and from_unixtime(publishTime,'%Y-%m-%d') = #{publishTimeStr}
		</if>
		<if test="ids != null">
			AND id in
			<foreach collection="ids" item="id" open="(" close=")"
					 separator=",">
				#{id}
			</foreach>
		</if>
		<if test="permissions!=null and permissions.size()>0">
			and (
			<foreach collection="permissions" item="permission" open="(" close=")" separator=") or (">
				<if test="permission.action=='self'">
					editorId=#{currentUserId} and  marketId=#{permission.moduleValue}
				</if>
				<if test="permission.action=='mng'">
					marketId=#{permission.moduleValue}
				</if>
			</foreach>
			)
		</if>
		<if test="permissions==null or permissions.size()==0">
			and marketId = 'none'
		</if>
	</sql>

	<!-- 开发负责人：延霄
	     功能说明：添加文章信息-->
	<insert id="addArticle" parameterType="articleDO" useGeneratedKeys="true" keyProperty="id">
		insert into TopicArticle(
		<include refid="basicColumn" />
		)values(
		<include refid="basicValues" />
		)
	</insert>

	<!-- 开发负责人：延霄
	     功能说明：更新文章信息-->
	<update id="updateArticle" parameterType="articleDO" >
		update TopicArticle
		set id = #{id}
		<if test="sort != null">
			,sort=#{sort}
		</if>
		<if test="title != null">
			,title=#{title}
		</if>
		<if test="img != null">
			,img = #{img}
		</if>
		<if test="marketId != null">
			,marketId = #{marketId}
		</if>
		<if test="topicId != null">
			,topicId = #{topicId}
		</if>
		<if test="type != null">
			,type = #{type}
		</if>
		<if test="isRecomItem != null">
			,isRecomItem = #{isRecomItem}
		</if>
		<if test="itemDataSource != null">
			,itemDataSource = #{itemDataSource}
		</if>
		<if test="itemInfos != null">
			,itemInfos = #{itemInfos}
		</if>
		<if test="publishTime != null">
			,publishTime = #{publishTime}
		</if>
		<if test="editorId != null">
			,editorId = #{editorId}
		</if>
		<if test="extra != null">
			,extra = #{extra}
		</if>
		<if test="status != null">
		    ,status= #{status}
		</if>
		<if test="isDeleted != null">
			,isDeleted= #{isDeleted}
		</if>
		<if test="updated != null">
			,updated = #{updated}
		</if>
		<if test="dataSourceCode != null">
			,dataSourceCode = #{dataSourceCode}
		</if>
		<if test="link != null">
			,link = #{link}
		</if>
		<if test="isWellChoiced != null">
			,isWellChoiced = #{isWellChoiced}
		</if>
		<if test="editorNick != null">
			,editorNick = #{editorNick}
		</if>
		where
		id = #{id}
		LIMIT 1
	</update>

	<!-- 开发负责人：延霄
         功能说明：查询文章总数 -->
	<select id="queryArticleListRowCount" parameterType="articleQuery" resultType="int">
		SELECT COUNT(1)
		FROM TopicArticle
		<where>
			<include refid="Where_Clause"/>
		</where>
		LIMIT 1
	</select>

	<!-- 开发负责人：延霄
    	 功能说明：根据条件查询文章列表 -->
	<select id="queryArticleList" parameterType="articleQuery" resultType="articleDO">
		SELECT <include refid="basicColumn" />
		FROM TopicArticle
		<where>
			<include refid="Where_Clause"/>
		</where>
		ORDER BY publishTime DESC,sort DESC
		<if test="start &gt;= 0 and pageSize &gt; 0">
			limit #{start}, #{pageSize}
		</if>
	</select>


	<select id="queryArticleReadOnly" parameterType="articleQuery" resultType="articleDO">
		SELECT <include refid="basicColumn" />
		FROM TopicArticle
		<where>
			<include refid="Where_Clause"/>
		</where>
		ORDER BY created DESC
		<if test="start &gt;= 0 and pageSize &gt; 0">
			limit #{start}, #{pageSize}
		</if>
	</select>

	<!-- 开发负责人：延霄
    	 功能说明：根据主键查询文章信息 -->
	<select id="queryArticleById" parameterType="java.lang.Long" resultType="articleDO">
		SELECT <include refid="basicColumn" />
		FROM  TopicArticle
		WHERE id = #{id}
		LIMIT 1
	</select>
</mapper>